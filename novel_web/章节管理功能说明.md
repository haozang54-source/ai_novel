# 章节管理功能说明

## 功能概述

在"章节编写"Tab中实现了完整的章节增删改功能，用户可以灵活管理小说章节。

## 后端API

### 1. 新增章节
- **路由**: `POST /api/chapters/outline/<outline_id>/chapters`
- **功能**: 在指定大纲中添加新章节
- **参数**:
  ```json
  {
    "title": "章节标题",
    "summary": "章节摘要",
    "conflicts": "核心冲突",
    "emotional_beat": "情感基调",
    "positioning": "定位",
    "character_growth": "人物成长"
  }
  ```
- **返回**: 新创建的章节信息

### 2. 更新章节信息
- **路由**: `PUT /api/chapters/outline-chapter/<outline_chapter_id>`
- **功能**: 更新大纲章节的元信息（标题、摘要等）
- **参数**: 同上
- **返回**: 更新后的章节信息

### 3. 删除章节
- **路由**: `DELETE /api/chapters/outline-chapter/<outline_chapter_id>`
- **功能**: 删除章节（会级联删除对应的正文内容）
- **特性**:
  - 删除后自动重新排序剩余章节
  - 自动更新章节编号
- **返回**: 成功消息

## 前端功能

### 章节列表
- 显示所有章节，包括：
  - 章节编号
  - 章节标题
  - 状态标签（未开始/草稿/审阅中/已完成）
  - 字数统计
- 支持点击选择章节进行编辑

### 操作按钮

#### 1. 新增章节
- 位置：章节列表卡片右上角
- 功能：打开新增章节模态框
- 表单字段：
  - 章节标题（必填）
  - 章节摘要
  - 核心冲突
  - 情感基调

#### 2. 编辑章节信息
- 位置：每个章节列表项的操作区
- 图标：编辑图标
- 功能：修改章节的元信息（不影响正文内容）

#### 3. 删除章节
- 位置：每个章节列表项的操作区
- 图标：删除图标（红色）
- 功能：删除章节及其正文内容
- 安全措施：
  - 二次确认弹窗
  - 提示会删除正文内容
  - 如果正在编辑被删除的章节，自动清空编辑器

## 使用流程

### 新增章节
1. 点击章节列表右上角的"新增"按钮
2. 填写章节信息
3. 点击"添加"按钮
4. 章节自动添加到列表末尾

### 编辑章节信息
1. 点击章节列表项右侧的编辑图标
2. 修改章节信息
3. 点击"保存"按钮
4. 章节信息更新

### 删除章节
1. 点击章节列表项右侧的删除图标
2. 在确认弹窗中点击"删除"
3. 章节及正文被删除
4. 剩余章节自动重新编号

## 注意事项

1. **大纲级别限制**：
   - 只有章级大纲才能进行章节管理
   - 卷级大纲需要先细化为章节大纲

2. **删除警告**：
   - 删除章节会同时删除已编写的正文内容
   - 操作不可逆，请谨慎操作

3. **自动编号**：
   - 新增章节会自动分配编号
   - 删除章节后剩余章节会自动重新编号

4. **状态管理**：
   - 新增章节默认状态为"未开始"
   - 编辑正文后状态变为"草稿"

## 技术实现

### 数据模型
- **OutlineChapter**: 大纲章节（存储章节元信息）
- **Chapter**: 正文章节（存储实际内容）
- 关系：一对一，OutlineChapter → Chapter

### 级联删除
- 删除 OutlineChapter 时自动删除关联的 Chapter
- 使用数据库级联（cascade='all, delete-orphan'）

### 自动排序
- 使用 `order_index` 字段维护章节顺序
- 删除后重新计算所有 `order_index` 和 `chapter_num`
