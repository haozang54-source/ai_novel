# 数据库迁移指南

## 添加 parent_id 字段到 outline_chapters 表

### 步骤 1: 运行迁移脚本

```bash
cd novel_web/backend
python migrate_add_parent_id.py
```

### 步骤 2: 验证迁移

迁移成功后，你会看到：
```
✓ 迁移成功：parent_id 字段已添加
```

如果字段已存在，会显示：
```
✓ parent_id 字段已存在，无需迁移
```

### 步骤 3: 重启应用

```bash
# 停止当前运行的 Flask 应用
# Ctrl+C

# 重新启动
python run.py
```

### 新功能说明

迁移完成后，你可以：

1. **在大纲编辑Tab中**：
   - 卷级大纲会显示为可展开的卡片
   - 每个卷卡片右上角有"添加章节"按钮
   - 点击卷可以展开查看该卷下的所有章节

2. **为卷添加章节**：
   - 点击"添加章节"按钮
   - 填写章节标题、摘要等信息
   - 提交后章节会自动关联到该卷

3. **层级结构**：
   - 卷（parent_id = null）
   - 章节（parent_id = 卷的ID）

### 故障排除

如果遇到错误：

1. **数据库锁定**：
   - 确保没有其他进程在使用数据库
   - 关闭所有数据库连接

2. **权限问题**：
   - 确保有数据库文件的写入权限

3. **回滚迁移**（如果需要）：
   ```bash
   # SQLite 不支持 DROP COLUMN，需要手动处理
   # 建议备份数据库后重新创建
   ```
